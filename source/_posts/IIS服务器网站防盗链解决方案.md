title: IIS服务器网站防盗链解决方案
categories: 网站百科
tags: [网站技巧]
date: 2020-06-11 14:38:37
id: 0003
---
  <p>我们知道，如果网站内容被盗链，那么流量和带宽都将有额外损耗，盗链严重时对网站运行会有明显的拖累影响。盗链最常见的情形就是图片地址被第三方网站直接引用，而拒绝本站文件被别人直接引用则可以从服务器层面寻求解决方案，今天我们就来讲讲在iis环境服务器上操作防盗链的方法。</p><p>盗链是指服务提供商自己不提供服务的内容，通过技术手段绕过其它有利益的最终用户界面（如广告），直接在自己的网站上向最终用户提供其它服务提供商的服务内容，骗取最终用户的浏览和点击率。受益者不提供资源或提供很少的资源，而真正的服务提供商却得不到任何的收益。</p><p>　　<strong>为什么会产生盗链？</strong></p><p>　　一般浏览有一个重要的现象就是一个完整的页面并不是一次全部传送到客户端的。如果请求的是一个带有许多图片和其它信息的页面，那么最先的一个Http请求被传送回来的是这个页面的文本，然后通过客户端的浏览器对这段文本的解释执行，发现其中还有图片，那么客户端的浏览器会再发送一条Http请求，当这个请求被处理后那么这个图片文件会被传送到客户端，然后浏览器回将图片安放到页面的正确位置，就这样一个完整的页面也许要经过发送多条Http请求才能够被完整的显示。基于这样的机制，就会产生一个问题，那就是盗链问题：就是一个网站中如果没有起页面中所说的信息，例如图片信息，那么它完全可以将这个图片的连接到别的网站。这样没有任何资源的网站利用了别的网站的资源来展示给浏览者，提高了自己的访问量，而大部分浏览者又不会很容易地发现，这样显然，对于那个被利用了资源的网站是不公平的。一些不良网站为了不增加成本而扩充自己站点内容，经常盗用其他网站的链接。一方面损害了原网站的合法利益，另一方面又加重了服务器的负担。</p><p>　　笔者网站遇到最多的是两类盗链，一是图片盗链，二是文件盗链。曾经有一个访问量极大的网站盗链笔者网站的图片，一天竟然消耗了数G的流量。同时，笔者站放的不少几十兆的大型软件也常遭到文件盗链，大量消耗本站资源。<br /></p><p>　　<strong>盗链的解决方案</strong></p><p>　　其实通过WEB服务器的URL过滤技术，这个伤脑筋的问题会很容易得到解决。&nbsp;</p><p>　　如果WEB服务器用的是APACHE的话，那么使用APACHE自带的Url Rewrite功能可以很轻松地防止各种盗链，其原理是检查REFER，如果REFER的信息来自其他网站则禁止访问所需要的资源。</p><p>　　那么，IIS支持UrlRewrite吗？</p><p>　　答案很简单，不支持。但是我们可以通过安装第三方服务器扩展让IIS支持。</p><p>　　目前有一种产品能比较好地支持IIS的UrlRewrite，名字叫ISAPI_Rewrite。</p><p>　　下载地址在： http://www.helicontech.com/download/</p><p>　　这里只有ISAPI Rewrite的一个LITE版本是免费的，其它都是trial版本。ISAPI Rewrite Lite的版本功能不支持虚拟站点配置，元数据监测和自动缓存清理。 但是基本的UrlRewrite功能都支持。</p><p>　　<strong>如何进行UrlRewrite的设置？</strong></p><p>　　isapi_rewrite利用正则表达式进行替换规则的表示。</p><p>　　下面是一个简单的例子，我想让我们的用户输入 http://localhost/test-12314.html 实际上访问的是 http://localhost/test.asp?id=12314 。那么我们的匹配表达式应该是 /test-([0-9]*).html 对应的格式化表达式应该为 /test.asp\?id=$1 。</p><p>　　进行正则表达式的编写的时候，可以利用isapi_rewrite提供的正则表达式测试工具（默认安装提供），进行调试。做好了匹配表达式和格式化表达式，我们可以把它们放到安装目录下的httpd.ini里面。文件保存后，不需重新启动iis即可生效。</p><p>　　对于我的网站，我防盗链的方法是在httpd.ini里面加入如下语句</p><blockquote>RewriteCond Host: (.+)<br />RewriteCond Referer: (?!http://\1.*).*<br />RewriteRule .*\.(?:gif|jpg|png|exe|rar|zip) /block.gif [I,O]</blockquote><p>　　然后重启IIS，这时防盗链就开始起作用了，其他网站盗链过来的请求都会被拒绝。</p><p>　　至此，我也终于可以摆脱了被盗链的烦恼了。</p>  